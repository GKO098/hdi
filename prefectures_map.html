<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>日本の都道府県地図</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="icons/favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; }
  </style>
</head>
<body>
  <!-- 市区町村のみ表示 -->
  <div style="position:absolute;z-index:1000;background:rgba(255,255,255,0.8);padding:8px 16px;top:10px;left:10px;border-radius:8px;">
    透明度：<input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="0.6" style="vertical-align:middle;width:120px;">
    <span id="opacityValue">0.60</span>
  </div>
  <div id="map"></div>
  <div style="position:absolute;z-index:900;bottom:10px;left:10px;background:rgba(255,255,255,0.8);padding:6px 14px;border-radius:8px;font-size:13px;">
    市区町村データの出典：国土交通省 国土数値情報
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // 地図の初期化（日本の中心付近）
    var map = L.map('map').setView([36.2048, 138.2529], 5);

    // OpenStreetMapのタイルレイヤー
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var geojsonLayer;
    var geojsonDataCity;
    var levelMap = {};
    var currentOpacity = 0.6;

    // 訪問レベルごとの色
    function getColor(level) {
      switch (level) {
        case '5': return '#e87afd'; // ピンク
        case '4': return '#f56d64'; // 赤
        case '3': return '#faff79'; // 黄
        case '2': return '#bbf59d'; // 緑
        case '1': return '#b7ddfd'; // 青
        default:  return '#ffffff'; // 白
      }
    }

    // ズームレベルに応じたweightを返す関数
    function getWeightByZoom(zoom) {
      if (zoom >= 10) return 2.5;
      if (zoom >= 7) return 1.2;
      return 0.5;
    }

    // jis.csvをパースして { '団体コード5桁' : 訪問レベル } のマップを作成
    function parseCSV(csv) {
      var lines = csv.trim().split(/\r?\n/);
      var headers = lines[0].split(',');
      var map = {};
      for (var i = 1; i < lines.length; i++) {
        var cols = lines[i].split(',');
        while (cols.length < headers.length) cols.push('');
        var row = {};
        headers.forEach(function(h, idx) {
          row[h] = cols[idx];
        });
        if (row['団体コード'] && row['訪問レベル']) {
          var key = row['団体コード'].slice(0, 5);
          map[key] = row['訪問レベル'];
        }
      }
      return map;
    }

    function getStyle(feature) {
      var code5 = feature.properties && feature.properties.N03_007;
      var level = code5 ? (levelMap[code5] || '') : '';
      return {
        color: '#000',
        weight: getWeightByZoom(map.getZoom()),
        fillOpacity: currentOpacity,
        fillColor: getColor(level)
      };
    }

    function renderGeoJSON() {
      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
      }
      geojsonLayer = L.geoJSON(geojsonDataCity, {
        style: getStyle,
        onEachFeature: function (feature, layer) {
          var code5 = feature.properties && feature.properties.N03_007;
          var name = (feature.properties.N03_001 || '') + ' ' +
                     (feature.properties.N03_003 || '') + ' ' +
                     (feature.properties.N03_004 || '');
          var level = code5 ? (levelMap[code5] || '') : '';
          if (!level) level = '未設定';
          layer.bindPopup(name + '<br>訪問レベル: ' + level);
        }
      }).addTo(map);
    }

    // ズーム変更時にweightを更新
    map.on('zoomend', function() {
      if (geojsonLayer) {
        var newWeight = getWeightByZoom(map.getZoom());
        geojsonLayer.eachLayer(function(layer) {
          layer.setStyle({ weight: newWeight });
        });
      }
    });

    // CSVとGeoJSONを両方読み込んでから描画
    Promise.all([
      fetch('data/jis.csv').then(r => r.text()),
      fetch('data/N03-21_210101.json').then(r => r.json())
    ]).then(function([csv, geojsonCity]) {
      levelMap = parseCSV(csv);
      geojsonDataCity = geojsonCity;
      renderGeoJSON();
    }).catch(function(error) {
      alert('データの読み込みに失敗しました: ' + error);
    });

    // 透明度スライダーのイベント
    document.addEventListener('DOMContentLoaded', function() {
      var slider = document.getElementById('opacitySlider');
      var valueLabel = document.getElementById('opacityValue');
      slider.addEventListener('input', function() {
        currentOpacity = parseFloat(this.value);
        valueLabel.textContent = currentOpacity.toFixed(2);
        if (geojsonLayer) {
          geojsonLayer.eachLayer(function(layer) {
            layer.setStyle({ fillOpacity: currentOpacity });
          });
        }
      });
    });
  </script>
</body>
</html> 
