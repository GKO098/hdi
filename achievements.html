<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Ÿç¸¾</title>
    <link rel="icon" type="image/png" href="icons/favicon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="achievements.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <h1>å®Ÿç¸¾</h1>
        <div class="description" style="margin-bottom: 20px;">
            <small>â€»æ²³å·ã‚„åºƒåŸŸãªå ´æ‰€ã®åº§æ¨™ã¯ã€ä»£è¡¨çš„ãªåœ°ç‚¹ã‚’é¸ã‚“ã§ã„ã¾ã™ã€‚</small>
            <small>â€»æ—¥ä»˜ã‚’æ€ã„å‡ºã›ãªã„å ´æ‰€ã¯xxxx-xx-xxã¨ã—ã¦ã„ã¾ã™ã€‚</small>
            <small>ã€Œ<a href="https://100sen.cyber-ninja.jp/" target="_blank" rel="noopener noreferrer">æ—¥æœ¬ç™¾é¸ã¨åº§æ¨™å€¤ï¼ˆçµŒç·¯åº¦æ•°å€¤ï¼‰</a>ã€ãªã©ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚</small>
        </div>
        <div id="achievements-container">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>

    <!-- åœ°å›³è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMap()">&times;</span>
            <h2 id="mapTitle"></h2>
            <div id="map"></div>
        </div>
    </div>

    <script src="./data/achievements_data.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = null;

        // å®Ÿç¸¾é …ç›®ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function createAchievementItem(id, spot) {
            const visited = spot.dates && spot.dates.length > 0;
            const mapLink = spot.coordinates
                ? `<div class="map-link">
                    <a href="https://www.google.com/maps?q=${spot.coordinates[0]},${spot.coordinates[1]}" target="_blank" rel="noopener noreferrer">
                        <small>ğŸ“åœ°å›³ã‚’é–‹ã</small>
                    </a>
                   </div>`
                : '';

            const datesHtml = visited
                ? spot.dates.map(date => `<div class="visit-date">${date}</div>`).join('')
                : '<div class="visit-date unvisited">æœªè¨ªå•</div>';

            return `
                <div class="achievement-item ${visited ? 'achieved' : ''}">
                    <h3>${spot.name}</h3>
                    <div class="achievement-dates" id="${id}-dates">
                        ${datesHtml}
                    </div>
                    ${mapLink}
                </div>
            `;
        }

        // å®Ÿç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function createAchievementSection(key, data) {
            const spots = data.type === 'list' ? data.spots : {};
            const items = Array.isArray(spots)
                ? spots.map(spot => createAchievementItem(spot.id, spot))
                : Object.entries(spots).map(([id, spot]) => createAchievementItem(id, spot));
            
            const totalCount = Array.isArray(spots) ? spots.length : Object.keys(spots).length;
            const visitedCount = Array.isArray(spots)
                ? spots.filter(spot => spot.dates && spot.dates.length > 0).length
                : Object.values(spots).filter(spot => spot.dates && spot.dates.length > 0).length;

            return `
                <div class="achievement-section">
                    <h2 class="clickable" onclick="showMapForCategory('${key}')">${data.title}</h2>
                    <div class="achievement-list" id="${key}-list">
                        ${items.join('')}
                    </div>
                    <div class="achievement-progress">
                        é€²æ—çŠ¶æ³: <span id="${key}-progress">${visitedCount}</span>/${totalCount}
                    </div>
                </div>
            `;
        }

        // å®Ÿç¸¾ã®æ›´æ–°é–¢æ•°
        function updateAchievements() {
            const container = document.getElementById('achievements-container');
            container.innerHTML = Object.entries(achievementsData)
                .map(([key, data]) => createAchievementSection(key, data))
                .join('');
        }

        // åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMapForCategory(key) {
            const data = achievementsData[key];
            const modal = document.getElementById('mapModal');
            const mapTitle = document.getElementById('mapTitle');
            
            mapTitle.textContent = data.title;
            modal.style.display = 'block';

            if (map) {
                map.remove();
            }

            map = L.map('map');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap & CartoDB',
                subdomains: 'abcd'
            }).addTo(map);

            // è¨ªå•æ¸ˆã¿ã¨æœªè¨ªå•ã®ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®šç¾©
            const visitedIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-circle" style="background-color: green;">âœ“</div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            const unvisitedIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-circle" style="background-color: red;">Ã—</div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            const spots = data.type === 'list' ? data.spots : {};
            const coordinates = [];
            
            if (Array.isArray(spots)) {
                spots.forEach(spot => {
                    if (spot.coordinates) {
                        coordinates.push(spot.coordinates);
                        const isVisited = spot.dates && spot.dates.length > 0;
                        L.marker(spot.coordinates, {
                            icon: isVisited ? visitedIcon : unvisitedIcon
                        })
                        .bindPopup(`
                            <strong>${spot.name}</strong><br>
                            ${isVisited ? 'è¨ªå•æ¸ˆã¿' : 'æœªè¨ªå•'}
                        `)
                        .addTo(map);
                    }
                });
            } else {
                Object.values(spots).forEach(spot => {
                    if (spot.coordinates) {
                        coordinates.push(spot.coordinates);
                        const isVisited = spot.dates && spot.dates.length > 0;
                        L.marker(spot.coordinates, {
                            icon: isVisited ? visitedIcon : unvisitedIcon
                        })
                        .bindPopup(`
                            <strong>${spot.name}</strong><br>
                            ${isVisited ? 'è¨ªå•æ¸ˆã¿' : 'æœªè¨ªå•'}
                        `)
                        .addTo(map);
                    }
                });
            }

            if (coordinates.length > 0) {
                const bounds = L.latLngBounds(coordinates);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // åœ°å›³ã‚’é–‰ã˜ã‚‹é–¢æ•°
        function closeMap() {
            const modal = document.getElementById('mapModal');
            modal.style.display = 'none';
            if (map) {
                map.remove();
                map = null;
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('mapModal');
            if (event.target == modal) {
                closeMap();
            }
        }

        // åˆæœŸè¡¨ç¤º
        updateAchievements();
    </script>
</body>
</html> 
